openapi: 3.0.0
info:
  version: 0.1.0
  title: KMFDDM server API
servers:
  - url: http://[::1]:9002/
paths:
  /version:
    get:
      description: Returns the running KMFDDM server version
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties: 
                  version:
                    type: string
                    example: "v0.1.0"
  /v1/declarations:
    get:
      security:
        - basicAuth: []
      responses:
        '200':
          $ref: '#/components/responses/Declaration'
        '401':
           $ref: '#/components/responses/UnauthorizedError'
        '400':
           $ref: '#/components/responses/JSONBadRequest'
        '500':
           $ref: '#/components/responses/JSONError'
    put:
      description: Store declaration. Adds new or overwrites an existing declaration. A declaration does not need to include the `ServerToken` field â€” KMFDDM generates one for you based on the content (it is ignored and overwritten if included).
      security:
        - basicAuth: []
      requestBody:
        $ref: '#/components/requestBodies/Declaration'
      responses:
        '204':
          description: Declaration already exists and is unchanged.
        '304':
          description: Declaration is either new or has changed.
        '401':
           $ref: '#/components/responses/UnauthorizedError'
        '400':
           $ref: '#/components/responses/JSONBadRequest'
        '500':
           $ref: '#/components/responses/JSONError'
  /v1/declarations/{id}:
    get:
      security:
        - basicAuth: []
    delete:
      security:
        - basicAuth: []
  /v1/declarations/{id}/touch:
    post:
      description: Updates a declaration's `ServerToken` only.
      security:
        - basicAuth: []
      responses:
        '204':
          description: Declaration server token successfully updated.
        '401':
           $ref: '#/components/responses/UnauthorizedError'
        '400':
           $ref: '#/components/responses/JSONBadRequest'
        '500':
           $ref: '#/components/responses/JSONError'
    parameters:
      - $ref: '#/components/parameters/declarationID'
  /v1/notify:
    post:
      description: Notify enrollment IDs by their ID or the sets they belong to, or, transitively, the declaration those sets are assigned.
      security:
        - basicAuth: []
      responses:
        '204':
          description: Notification request received. See server logs for result (notification may be async).
        '401':
           $ref: '#/components/responses/UnauthorizedError'
        '500':
           $ref: '#/components/responses/JSONError'
      parameters:
        - in: query
          name: declaration
          schema:
            type: array
            items:
              type: string
          example: ['com.example.test']
          explode: true
        - in: query
          name: set
          schema:
            type: array
            items:
              type: string
          example: ['default']
          explode: true
        - in: query
          name: id
          schema:
            type: array
            items:
              type: string
          example: ['4A80F3DA-2738-434D-B95C-856811130F3B']
          explode: true
components:
  parameters:
    declarationID:
      name: id
      in: path
      description: Identifier of the declaration.
      required: true
      style: simple
      schema:
        type: string
        example: 'com.example.test'
  securitySchemes:
    basicAuth:
      type: http
      scheme: basic
  requestBodies:
    Declaration:
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Declaration'
  responses:
    Declaration:
      description: Declaration.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Declaration'
    UnauthorizedError:
      description: API key is missing or invalid.
      headers:
        WWW-Authenticate:
          schema:
            type: string
    BadRequest:
      description: There was a problem with the supplied request. The request was in an incorrect format or other request data error. See server logs for more information.
      content:
        text/plain:
          schema:
            type: string
            example: Bad Request
    Error:
      description: An internal server error occured on this endpoint. See server logs for more information.
      content:
        text/plain:
          schema:
            type: string
            example: Internal Server Error
    JSONBadRequest:
      description: There was a problem with the supplied request. The request was in an incorrect format or other request data error.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/JSONError'  
    JSONError:
      description: An internal server error occured on this endpoint.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/JSONError'
  schemas:
    JSONError:
      type: object
      properties:
        error:
          type: string
          example: "it was sunny outside"
    Declaration:
      type: object
      properties:
        Identifier:
          type: string
          example: "E3ADE6E6-0CF5-4C3B-BD4F-92AD2EB0500A"
        ServerToken:
          type: string
          example: d41d8cd98f00b204e9800998ecf8427e
        Payload:
          type: object
        Type:
          type: string
          example: "com.apple.configuration.management.test"